# Q & A

## Q. `-lpthread` というコンパイラオプションはないとダメなの？

- `pthread_create` みたいな「スレッドを作る関数」は、標準 C ライブラリ (`libc`) には入っていなくて、別の部品（ライブラリ）で提供されています。その部品の名前が `libpthread` です。
- **`libpthread`**
  - POSIX スレッド (pthread) 用の関数を集めたライブラリ。カーネルスレッドを作る (`pthread_create`)、待つ (`pthread_join`)、シグナルマスクを操作する (`pthread_sigmask`) などがここに入っています。

コンパイルするとき、コンパイラはソースコードを読むだけでは `pthread_create` の中身を知りません。そこで「このプログラムは `libpthread` という部品を使いますよ」と伝えないといけない。その合図が `-pthread`（または `-lpthread`）オプションです。

- `-pthread`（または `-lpthread`）オプションを付けると、コンパイラは「pthread 用の設定を入れて、最終的なバイナリに `libpthread` をくっつけよう」と動きます。
- 付け忘れると `pthread_create` の本体が見つからず、「未定義参照」というエラーになってしまいます。

要するに、「スレッドを使うときは `libpthread` を連れてきてほしい」と指示する旗が `-pthread`（または `-lpthread`）オプションです。

## Q. `pthread_create` で生成されるスレッドはカーネルスレッドで合ってる？

うん、今の Linux (NPTL) では `pthread_create` でできるのはユーザースペースのスレッドというより、1 本ずつカーネルスレッドとして管理される 1:1 モデルです。

- `pthread_create` が呼ばれると、glibc の中で `clone(2)` システムコールが実行され、OS に「新しいスレッドを作ってください」と頼みます。ここで作られるのはカーネルが直接追いかけるスレッド（LWP: Light Weight Process）。
- 各スレッドは固有のスレッド ID (TID) を持ち、スケジューラも他のプロセスと同じように扱います。
- だから `pthread_kill` でシグナルを飛ばすと個々のカーネルスレッドに届きますし、`top` や `/proc` にも別スレッドとして現れます。

昔は 1:1 でない実装（M:N モデルなど）もありましたが、現在の主流 Linux では `pthread` ≒ カーネルスレッド、と考えて問題ありません。

## Q. カーネルスレッドってプロセスとして認識されるの？

Linux では「スレッド ＝ `clone()` で作られたタスク」です。

どのタスクもカーネル内では `task_struct` 1 個として扱われ、スケジューラから見れば全部プロセスと同じノリで動きます。

ただし、ユーザーが見るときには 2 段階の ID があって:

- `tgid` (thread group ID)
  - いわゆるプロセス ID。`main()` を呼び出した最初のスレッドの ID と同じ値。`ps` で普通に表示されるのはこれ。
- `tid` (thread ID)
  - 各スレッド固有の ID。`/proc/<tgid>/task/<tid>` に姿があり、`ps -L` や `top -H` など「スレッドを表示するモード」ではこの ID で一覧できます。

なので回答としては:

- カーネル的には全部「スケジュール可能なタスク」で、プロセスと同じ枠で管理される。
- けれどユーザーランドの多くのツールは同じ `tgid` を共有しているスレッドを 1 つのプロセスとしてまとめて表示する。

つまり「カーネルスレッドはプロセスか？」と聞かれたら、「OS 内部ではプロセスと同じ扱いを受けるが、ユーザー空間では同じ `tgid` を持つ仲間として一つのプロセスに見えている」と覚えておくと整理しやすいです。

### Q. タスクとスレッドの違いは？

Linux まわりで言う「タスク」と「スレッド」は、文脈によって指す範囲が少し違いますが、整理するとこうなります。

- **タスク (task)**
  - カーネルランド視点の用語。`task_struct` という構造体 1 個が 1 つの「実行単位」を表します。
  - 1:1 スレッドモデルの Linux では、ユーザープロセスの各スレッドもカーネルスレッドも、全部 `task_struct` で管理されるので、**スレッドもプロセスもカーネル視点では「タスク」**です。
- **スレッド (thread)**
  - ユーザーランド視点の用語。ユーザーランドから見た「**同じアドレス空間を共有する実行単位**」。
  - POSIX では、**プロセス内で並列に動く軽量な実行単位**を表し、Linux の pthread は 1 タスク = 1 スレッドの実装になっています。
  - スレッド同士は `tgid` (thread group ID) を共有し、一緒に 1 プロセスとして扱われるのが通常の見え方。

まとめると、「タスク」はカーネル内部の最小スケジューリング単位の呼び名、「スレッド」はユーザープロセス内で並列動作するタスクの集合のこと。Linux では両者が 1:1 で対応しているので、ほぼ同じものだと捉えて大丈夫ですが、誰の視点の言葉かを意識すると混乱しにくくなります。
